version: 2.1

orbs:
  aws-cli: circleci/aws-cli@4.0

executors:
  default:
    description: CircleCI Ubuntu machine executor
    machine:
      image: ubuntu-2004:2024.01.2

jobs:
  build-prod:
    executor: default
    parameters:
      svc:
        type: string
        default: "decklingo"
    working_directory: ~/project
    environment:
      TZ: "/usr/share/zoneinfo/Asia/Kolkata"
      AWS_ROLE_ARN: arn:aws:iam::475757276268:role/circleci
    steps:
      - checkout
      - skip_if_no_changes_in_solutions_apis

      - aws-cli/setup:
          role_arn: $AWS_ROLE_ARN
          role_session_name: circleci-oidc-session

      - run:
          name: Login to ECR (ap-south-1)
          command: |
            aws ecr get-login-password --region ap-south-1 \
              | docker login --username AWS --password-stdin 475757276268.dkr.ecr.ap-south-1.amazonaws.com

      - run:
          name: Build docker image (decklingo-ai/<<parameters.svc>>)
          command: |
            docker build \
              -t decklingo-ai/<<parameters.svc>>:latest \
              -f ./Dockerfile \
              .
          no_output_timeout: 30m

      - run:
          name: Tag & Push docker image + prepare state
          command: |
            set -e
            ROOT_DIR="$(pwd)"
            STATE_DIR="$ROOT_DIR/.ci_state"
            mkdir -p "$STATE_DIR"

            TRANSFORMED_CIRCLE_BRANCH="$(echo "$CIRCLE_BRANCH" | sed -e 's#/#-#g')"
            IMAGE_TAG="${TRANSFORMED_CIRCLE_BRANCH}-<< pipeline.number >>"

            docker tag playment/decklingo-ai/<<parameters.svc>>:latest \
              475757276268.dkr.ecr.ap-south-1.amazonaws.com/playment/decklingo-ai/<<parameters.svc>>:${IMAGE_TAG}
            docker push 475757276268.dkr.ecr.ap-south-1.amazonaws.com/playment/decklingo-ai/<<parameters.svc>>:${IMAGE_TAG}

            {
              echo "IMAGE_TAG=${IMAGE_TAG}"
              echo "SYNC_REQUIRED=false"
            } > "$STATE_DIR/env"

      - run:
          name: Bump image tag in play-kube (decklingo-ai)
          command: |
            set -e
            ROOT_DIR="$(pwd)"
            STATE_DIR="$ROOT_DIR/.ci_state"
            . "$STATE_DIR/env"

            git clone "https://${GITHUB_TOKEN}@github.com/crowdflux/play-kube.git"
            cd play-kube/charts/decklingo-ai

            # Update only the tag field (repo unchanged)
            sed -i "s/tag: [^ ]*/tag: ${IMAGE_TAG}/" values.yaml

            git config user.email "tii_tiai_cv_devops@telusinternational.com"
            git config user.name "devops-telus"

            if git diff --quiet; then
              echo "No changes to commit."
            else
              git add values.yaml
              git commit -m "decklingo-ai: <<parameters.svc>> tag -> ${IMAGE_TAG}"
              # Push with basic retry
              for i in 1 2 3 4 5; do
                if git pull --rebase origin master && git push "https://${GITHUB_TOKEN}@github.com/crowdflux/play-kube.git" master; then
                  echo "Pushed values.yaml update."
                  # Mark sync required in absolute state path
                  sed -i 's/^SYNC_REQUIRED=.*/SYNC_REQUIRED=true/' "$STATE_DIR/env" || echo "SYNC_REQUIRED=true" >> "$STATE_DIR/env"
                  break
                fi
                echo "Push failed, retrying in 5s... ($i/5)"
                sleep 5
              done
            fi

      - persist_to_workspace:
          root: .
          paths:
            - .ci_state

  # deploy-prod:
  #   docker:
  #     - image: 475757276268.dkr.ecr.ap-south-1.amazonaws.com/circleci/base:argocd
  #       aws_auth:
  #         aws_access_key_id: $AWS_ACCESS_KEY_ID
  #         aws_secret_access_key: $AWS_SECRET_ACCESS_KEY
  #   resource_class: crowdflux/internaltool
  #   working_directory: ~/project
  #   environment:
  #     TZ: "/usr/share/zoneinfo/Asia/Kolkata"
  #   steps:
  #     - checkout
  #     - attach_workspace:
  #         at: .
  #     - run:
  #         name: Load IMAGE_TAG & SYNC_REQUIRED
  #         command: |
  #           if [ -f .ci_state/env ]; then
  #             . .ci_state/env
  #           fi
  #           echo "IMAGE_TAG=${IMAGE_TAG:-missing}"
  #           echo "SYNC_REQUIRED=${SYNC_REQUIRED:-false}"

  #     - run:
  #         name: ArgoCD refresh & sync via argocd CLI
  #         command: |
  #           if [ "${SYNC_REQUIRED}" != "true" ]; then
  #             echo "No chart change detected; skipping Argo operations."
  #             exit 0
  #           fi

  #           : "${ARGOCD_PROD_SERVER:?set in context}"
  #           : "${ARGOCD_PROD_USERNAME:?set in context}"
  #           : "${ARGOCD_PROD_PASSWORD:?set in context}"

  #           # Login (same switches as other working repos)
  #           argocd login "$ARGOCD_PROD_SERVER" \
  #             --username "$ARGOCD_PROD_USERNAME" \
  #             --password "$ARGOCD_PROD_PASSWORD" \
  #             --grpc-web \
  #             --skip-test-tls

  #           # Refresh & sync the app
  #           argocd app get decklingo-ai --refresh
  #           if ! argocd app sync decklingo-ai; then
  #             echo "Sync failed, but continuing to let pipeline finish."
  #           fi

workflows:
  version: 2
  deploy:
    jobs:
      - build-prod:
          name: build-prod
          svc: "decklingo"
          filters:
            branches:
              only: main
          context:
            - aws-auth
            - org-global
      # - deploy-prod:
      #     name: deploy-prod
      #     requires:
      #       - build-prod
      #     filters:
      #       branches:
      #         only: main
      #     context:
      #       - circleci-aws-creds   
      #       - org-global
